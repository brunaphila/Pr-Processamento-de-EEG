% Script: aplicar_filtro_CAR_em_lote.m
% Aplica filtro CAR apenas nos canais C3, Cz e C4

% 1. Caminhos
pasta_origem = 'C:\Users\Bruna\Documents\IC\Dados\Protocolo_C\dados_concatenados_removido';
pasta_destino = 'C:\Users\Bruna\Documents\IC\Dados\Protocolo_C\CAR especifico';

% Garante que a pasta de destino exista
if ~exist(pasta_destino, 'dir')
    mkdir(pasta_destino);
    fprintf('üìÅ Pasta de destino criada: %s\n', pasta_destino);
end

% 2. Lista todos os arquivos .set na pasta de origem
arquivos_set = dir(fullfile(pasta_origem, '*.set'));

if isempty(arquivos_set)
    error('Nenhum arquivo .set encontrado na pasta de origem.');
end

fprintf('üîÑ Iniciando processamento de %d arquivos...\n', length(arquivos_set));

% 3. Define os canais espec√≠ficos para o CAR
canais_CAR = {'C3', 'Cz', 'C4'};

% 4. Loop por todos os arquivos
for i = 1:length(arquivos_set)
    nome_arquivo = arquivos_set(i).name;
    fprintf('\n‚û°Ô∏è  Processando: %s\n', nome_arquivo);
    
    % Carrega o EEG
    EEG = pop_loadset('filename', nome_arquivo, 'filepath', pasta_origem);
    
    % Encontra os √≠ndices dos canais C3, Cz e C4
    indices = [];
    for j = 1:length(canais_CAR)
        idx = find(strcmpi({EEG.chanlocs.labels}, canais_CAR{j}));
        if ~isempty(idx)
            indices = [indices, idx];
        else
            fprintf('‚ö†Ô∏è  Canal %s n√£o encontrado no arquivo %s\n', canais_CAR{j}, nome_arquivo);
        end
    end
    
    if length(indices) == 3
        % Aplica o filtro CAR apenas nos canais C3, Cz e C4
        media_CAR = mean(EEG.data(indices, :), 1);
        EEG.data(indices, :) = EEG.data(indices, :) - media_CAR;
        
        fprintf('‚úÖ CAR aplicado em C3, Cz, C4\n');
    else
        fprintf('‚ùå N√£o foi poss√≠vel aplicar CAR - canais n√£o encontrados\n');
    end
    
    % Adiciona hist√≥rico do processamento
    EEG = eeg_hist(EEG, 'Filtro CAR aplicado apenas nos canais C3, Cz, C4');
    
    % Define novo nome do arquivo
    [~, nome_base, ~] = fileparts(nome_arquivo);
    nome_novo = [nome_base, '_CAR_C3CzC4.set'];
    
    % Salva o novo arquivo
    pop_saveset(EEG, 'filename', nome_novo, 'filepath', pasta_destino);
    fprintf('‚úÖ Arquivo salvo: %s\n', fullfile(pasta_destino, nome_novo));
end

fprintf('\nüèÅ Filtro CAR aplicado em C3, Cz, C4 em todos os arquivos.\n');
